{% comment %}
  goodr Popup (Section)
  - Renders hidden modal markup (no CLS)
  - Loads scoped CSS/JS assets
  - Passes configuration via data-* attributes
{% endcomment %}

{% if section.settings.enabled %}
  {{ 'goodr-popup.css' | asset_url | stylesheet_tag }}

  <section
    class="goodr_popup"
    data-goodr-popup-root
    data-goodr-popup-id="{{ section.id }}"
    data-enabled="{{ section.settings.enabled }}"
    data-trigger-type="{{ section.settings.trigger_type }}"
    data-delay-section="{{ section.settings.delay_seconds }}"
    data-scroll-percent="{{ section.settings.scroll_percent }}"
    data-dismiss-ttl-days="{{ section.settings.dismiss_ttl_days }}"
    data-show-once-per-ttl="{{ section.settings.show_once_per_ttl }}"
    data-utm-campaign="{{ section.settings.utm_campaign }}"
    data-debug="{{ section.settings.debug }}"
    aria-label="$5 OFF offer pop up"
  >
    <div
      class="goodr_popup__content"
      data-goodr-popup-content
      role="dialog"
      aria-modal="true"
      aria-labelledby="goodr_popup_title_{{ section.id }}"
      aria-describedby="goodr_popup_desc_{{ section.id }}"
      tabindex="-1"
      hidden
    >
      {% if section.settings.close_button != blank %}
        <button
          class="goodr_popup__close__button"
          data-goodr-popup-close
          aria-label="Close popup"
          type="button"
        >
          {{
            section.settings.close_button
            | image_url: width: 20, height: 20
            | image_tag: loading: 'lazy', class: 'goodr_popup__close__icon', alt: 'Popup close button'
          }}
        </button>
      {% endif %}

      {% comment %} Desktop Image {% endcomment %}
      {% if section.settings.desktop_image != blank %}
        <div
          class="goodr_popup__media__desktop"
          aria-hidden="true"
        >
          {{
            section.settings.desktop_image
            | image_url: width: 374
            | image_tag: loading: 'lazy', class: 'goodr_popup__desktop__media__image', alt: ''
          }}
          {% if section.settings.logo != blank %}
            {{
              section.settings.logo
              | image_url: width: 200
              | image_tag: loading: 'lazy', class: 'goodr_popup__media__desktop__logo', alt: 'goodr logo'
            }}
          {% endif %}
        </div>
      {% endif %}

      {% comment %} Mobile Image {% endcomment %}
      {% if section.settings.mobile_image != blank %}
        <div
          class="goodr_popup__media__mobile"
          aria-hidden="true"
        >
          {{
            section.settings.mobile_image
            | image_url: width: 252
            | image_tag: loading: 'lazy', class: 'goodr_popup__mobile__media__image', alt: ''
          }}

          {% if section.settings.logo != blank %}
            {{
              section.settings.logo
              | image_url: width: 150
              | image_tag: loading: 'lazy', class: 'goodr_popup__media__mobile__logo', alt: 'goodr logo'
            }}
          {% endif %}
        </div>
      {% endif %}

      {% if section.settings.title_before != blank %}
        <h2 class="goodr_popup__title" id="goodr_popup_title_{{ section.id }}">
          {{ section.settings.title_before }}
          <span class="goodr_popup__code">{{ section.settings.coupon_code }}</span>
          {{ section.settings.title_after }}
        </h2>

        {%- comment -%}
          Screen-reader-only description so aria-describedby points to a real node.
          Uses an inline style to avoid requiring CSS changes.
        {%- endcomment -%}
        <p
          id="goodr_popup_desc_{{ section.id }}"
          style="position:absolute!important; width:1px!important; height:1px!important; padding:0!important; margin:-1px!important; overflow:hidden!important; clip:rect(0,0,0,0)!important; white-space:nowrap!important; border:0!important;"
        >
          Use code {{ section.settings.coupon_code }} at checkout to receive $5 off your first order.
        </p>
      {% endif %}

      <div class="goodr_popup__buttons">
        {% if section.settings.cta_text != blank %}
          <button
            class="goodr_popup__cta__button"
            type="button"
            data-goodr-popup-submit
          >
            <p class="goodr_popup__cta__button__text">{{ section.settings.cta_text }}</p>
          </button>
        {% endif %}

        {% if section.settings.dismissal_text != blank %}
          <button
            class="goodr_popup__dismissal__button"
            type="button"
            data-goodr-popup-dismiss
          >
            <p class="goodr_popup__dismissal__button__text">{{ section.settings.dismissal_text }}</p>
          </button>
        {% endif %}
      </div>
    </div>
  </section>
{% endif %}

<script src="{{ 'goodr-popup.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "goodr Popup",
  "settings": [
    { "type": "checkbox", "id": "enabled", "label": "Enable popup", "default": false },
    { "type": "image_picker", "id": "close_button", "label": "Popup close icon" },
    { "type": "image_picker", "id": "desktop_image", "label": "Desktop image" },
    { "type": "image_picker", "id": "mobile_image", "label": "Mobile image" },
    { "type": "image_picker", "id": "logo", "label": "Logo" },
    { "type": "text", "id": "title_before", "label": "Title (before code)", "default": "USE CODE" },
    { "type": "text", "id": "coupon_code", "label": "Coupon code", "default": "GOODR5" },
    { "type": "text", "id": "title_after", "label": "Title (after code)", "default": "FOR $5 OFF YOUR FIRST ORDER" },
    { "type": "text", "id": "cta_text", "label": "CTA button text", "default": "SHOP ALL STYLES" },
    { "type": "text", "id": "dismissal_text", "label": "Dismissal button text", "default": "NAH, I HATE DEALS" },
    {
      "type": "select",
      "id": "trigger_type",
      "label": "Trigger type",
      "default": "delay",
      "options": [
        { "value": "delay", "label": "Time delay" },
        { "value": "scroll", "label": "Page Scroll Percentage" },
        { "value": "exit", "label": "Exit intent" },
        { "value": "utm", "label": "UTM Campaign match" }
      ]
    },
    {
      "type": "range",
      "id": "delay_seconds",
      "label": "Time Delay (seconds)",
      "min": 0,
      "max": 60,
      "step": 1,
      "default": 5
    },
    {
      "type": "range",
      "id": "scroll_percent",
      "label": "Scroll Trigger (%)",
      "min": 5,
      "max": 95,
      "step": 5,
      "default": 35
    },
    { "type": "text", "id": "utm_campaign", "label": "UTM campaign match" },
    {
      "type": "range",
      "id": "dismiss_ttl_days",
      "label": "Do not show again for (days)",
      "min": 0,
      "max": 90,
      "step": 1,
      "default": 1
    },
    {
      "type": "checkbox",
      "id": "show_once_per_ttl",
      "label": "Show only once per time period (even if not dismissed)",
      "default": true
    },
    { "type": "checkbox", "id": "debug", "label": "Debug logging", "default": false }
  ],
  "presets": [{ "name": "goodr Popup" }]
}
{% endschema %}
